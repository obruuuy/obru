<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembelajaran Basis Data</title>
    <!-- Memuat Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .tab-active {
            border-bottom: 3px solid #10b981; /* emerald-500 */
            color: #10b981;
        }
        .code-input {
            font-family: monospace;
            resize: vertical;
            min-height: 80px;
        }
        .correct-answer {
            color: #059669; /* green-600 */
        }
        .incorrect-answer {
            color: #dc2626; /* red-600 */
        }
        /* Custom scrollbar for content area */
        .content-area::-webkit-scrollbar {
            width: 8px;
        }
        .content-area::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-6">

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-xl card overflow-hidden">
        
        <!-- Header Aplikasi -->
        <header class="p-5 border-b bg-emerald-600 text-white">
            <h1 class="text-2xl font-bold">📚 Pembelajaran Basis Data Interaktif</h1>
            <p id="auth-status" class="text-sm mt-1 text-emerald-100">Status: Memuat...</p>
        </header>

        <!-- Navigasi Tab -->
        <nav class="flex justify-around border-b bg-gray-50">
            <button id="tab-materi" onclick="switchView('materi')"
                    class="tab-button w-1/3 py-3 text-center text-sm font-semibold text-gray-600 hover:bg-gray-100 transition duration-150 ease-in-out tab-active">
                Materi Dasar
            </button>
            <button id="tab-sql" onclick="switchView('sql')"
                    class="tab-button w-1/3 py-3 text-center text-sm font-semibold text-gray-600 hover:bg-gray-100 transition duration-150 ease-in-out">
                Dasar-Dasar SQL
            </button>
            <button id="tab-kuis" onclick="switchView('kuis')"
                    class="tab-button w-1/3 py-3 text-center text-sm font-semibold text-gray-600 hover:bg-gray-100 transition duration-150 ease-in-out">
                Kuis Praktik SQL
            </button>
        </nav>

        <!-- Area Konten Utama -->
        <div id="content-area" class="content-area p-5 h-[70vh] overflow-y-auto">

            <!-- 1. Konten Materi Dasar (Tidak berubah) -->
            <div id="view-materi" class="view-content">
                <h2 class="text-xl font-bold mb-4 text-emerald-700">Materi 1: Konsep Dasar Basis Data</h2>
                
                <section class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-blue-700">Apa Itu Basis Data?</h3>
                    <p class="text-gray-700">
                        **Basis Data (Database)** adalah koleksi data yang terorganisir dan saling berhubungan, biasanya disimpan dan diakses secara elektronik dari sistem komputer. Tujuannya adalah untuk mengelola dan mengambil data dengan efisien.
                    </p>
                </section>

                <section class="mb-6 p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-700">Struktur Dasar</h3>
                    <ul class="list-disc pl-5 text-gray-700 space-y-2">
                        <li>
                            **Tabel (Table):** Struktur utama untuk menyimpan data. Terdiri dari baris dan kolom. Anggap seperti lembar kerja di Excel.
                        </li>
                        <li>
                            **Kolom (Column/Field):** Merepresentasikan atribut atau jenis data tertentu (misalnya, Nama, Usia, ID).
                        </li>
                        <li>
                            **Baris (Row/Record):** Merepresentasikan satu entitas atau satu set data yang lengkap (misalnya, semua informasi tentang satu orang).
                        </li>
                    </ul>
                </section>
                
                <section class="mb-6 p-4 bg-purple-50 border-l-4 border-purple-500 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-purple-700">Kunci Utama (Primary Key)</h3>
                    <p class="text-gray-700">
                        Kunci Utama adalah kolom atau kombinasi kolom yang secara unik mengidentifikasi setiap baris dalam sebuah tabel.
                        Ini sangat penting untuk memastikan tidak ada data yang duplikat dan untuk membuat relasi.
                    </p>
                </section>
            </div>

            <!-- 2. Konten Dasar-Dasar SQL (Tidak berubah) -->
            <div id="view-sql" class="view-content hidden">
                <h2 class="text-xl font-bold mb-4 text-emerald-700">Materi 2: Bahasa SQL (Structured Query Language)</h2>

                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-700">1. SELECT (Mengambil Data)</h3>
                    <p class="text-gray-700 mb-2">Perintah paling dasar untuk mengambil data dari satu atau lebih tabel. Tanda * berarti "semua kolom".</p>
                    <pre class="bg-gray-800 text-white p-3 rounded-lg overflow-x-auto text-sm">
<code class="language-sql">-- Mengambil semua kolom dari tabel 'Pengguna'
SELECT * FROM Pengguna;

-- Mengambil hanya kolom 'Nama' dan 'Email' dari tabel 'Pengguna'
SELECT Nama, Email FROM Pengguna;

-- Mengambil data dengan kondisi
SELECT * FROM Produk WHERE Harga > 50000;</code>
                    </pre>
                </section>

                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-700">2. INSERT (Memasukkan Data)</h3>
                    <p class="text-gray-700 mb-2">Perintah untuk menambahkan baris baru ke dalam sebuah tabel.</p>
                    <pre class="bg-gray-800 text-white p-3 rounded-lg overflow-x-auto text-sm">
<code class="language-sql">-- Memasukkan data ke semua kolom (urutan harus sesuai)
INSERT INTO Karyawan VALUES (101, 'Budi Santoso', 'IT');

-- Memasukkan data hanya ke kolom spesifik
INSERT INTO Karyawan (ID, Nama) VALUES (102, 'Citra Dewi');</code>
                    </pre>
                </section>

                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-2 text-indigo-700">3. UPDATE (Memperbarui Data)</h3>
                    <p class="text-gray-700 mb-2">Perintah untuk memodifikasi data yang sudah ada di dalam tabel. **PERHATIAN: Selalu gunakan WHERE!**</p>
                    <pre class="bg-gray-800 text-white p-3 rounded-lg overflow-x-auto text-sm">
<code class="language-sql">-- Memperbarui kolom 'Departemen' untuk Karyawan dengan ID 101
UPDATE Karyawan
SET Departemen = 'Keuangan'
WHERE ID = 101;</code>
                    </pre>
                </section>
            </div>
            
            <!-- 3. Konten Kuis Praktik SQL (Diperbarui) -->
            <div id="view-kuis" class="view-content hidden">
                <h2 class="text-xl font-bold mb-4 text-emerald-700">Kuis Praktik SQL: Tulis Kode Anda!</h2>
                <p class="mb-4 text-gray-600">Tulis perintah SQL yang benar pada kotak kode untuk menyelesaikan setiap tugas. Perintah tidak harus diakhiri dengan titik koma.</p>
                
                <div id="quiz-container">
                    <!-- Soal Kuis Praktik akan dimuat di sini oleh JS -->
                    <div class="text-center py-10 text-gray-500">Kuis akan dimuat sebentar lagi...</div>
                </div>

                <div id="quiz-results" class="hidden mt-6 p-5 bg-white rounded-xl shadow-lg border-t-4 border-emerald-500">
                    <h3 class="text-xl font-bold mb-3 text-center text-emerald-600">Hasil Praktik Anda</h3>
                    <p id="final-score" class="text-4xl font-extrabold text-center mb-4 text-emerald-800">0 / 0</p>
                    <p id="score-message" class="text-center mb-4 text-gray-700"></p>
                    <button onclick="resetQuiz()" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150">
                        Coba Lagi
                    </button>
                    <p id="firestore-status" class="text-sm mt-3 text-center text-gray-500">Status Penyimpanan Skor: Menunggu...</p>
                </div>

                <div id="loading-spinner" class="hidden text-center py-10">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"></div>
                    <p class="mt-2 text-gray-500">Memproses...</p>
                </div>

                <button id="submit-quiz-btn" onclick="submitQuiz()"
                        class="w-full py-3 bg-emerald-600 text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-150 mt-6 hidden">
                    Kirim Jawaban & Periksa
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global dari Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let userId = null;
        let isAuthReady = false;

        // Mendapatkan referensi global
        window.db = db;
        window.auth = auth;
        window.getUserId = () => userId;
        window.isAuthReady = () => isAuthReady;
        window.saveScoreToFirestore = saveScoreToFirestore;
        
        const authStatusEl = document.getElementById('auth-status');
        const firestoreStatusEl = document.getElementById('firestore-status');
        
        /**
         * Mengonfigurasi dan mengautentikasi Firebase/Firestore.
         */
        async function setupFirebase() {
            if (!firebaseConfig) {
                authStatusEl.textContent = 'Status: Firebase Config tidak tersedia.';
                console.error("Firebase config tidak ditemukan. Menyimpan skor tidak akan berfungsi.");
                return;
            }

            try {
                // Aktifkan logging debug
                setLogLevel('debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Pastikan variabel global diperbarui
                window.db = db;
                window.auth = auth;

                // 1. Dengarkan Perubahan Status Otentikasi
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `Status: Terhubung (${userId.substring(0, 8)}...)`;
                        isAuthReady = true;
                    } else {
                        // Jika tidak ada user, coba sign-in
                        authStatusEl.textContent = 'Status: Mengautentikasi anonim...';
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Gagal melakukan sign-in:", error);
                            authStatusEl.textContent = 'Status: Otentikasi Gagal.';
                            isAuthReady = true;
                        }
                    }
                });

                // Jika token sudah ada, langsung coba sign-in
                if (initialAuthToken) {
                     await signInWithCustomToken(auth, initialAuthToken);
                }

            } catch (error) {
                console.error("Gagal menginisialisasi Firebase:", error);
                authStatusEl.textContent = 'Status: Inisialisasi Firebase Gagal.';
            }
        }

        /**
         * Menyimpan skor kuis ke Firestore.
         * @param {number} score - Skor yang didapat.
         * @param {number} totalQuestions - Jumlah total soal.
         */
        async function saveScoreToFirestore(score, totalQuestions) {
            if (!db || !isAuthReady) {
                firestoreStatusEl.textContent = 'Status Penyimpanan Skor: Firebase belum siap.';
                return;
            }
            
            const scoreData = {
                score: score,
                totalQuestions: totalQuestions,
                percentage: (score / totalQuestions) * 100,
                timestamp: new Date().toISOString(),
                appId: appId
            };

            const userUid = getUserId();
            // Path koleksi untuk menyimpan skor kuis
            const collectionPath = `/artifacts/${appId}/users/${userUid}/db_learning_scores`;
            
            // Menggunakan timestamp sebagai ID dokumen untuk menyimpan setiap percobaan kuis
            const docRef = doc(collection(db, collectionPath), Date.now().toString());

            firestoreStatusEl.textContent = 'Status Penyimpanan Skor: Menyimpan...';

            try {
                await setDoc(docRef, scoreData);
                firestoreStatusEl.textContent = `Status Penyimpanan Skor: Berhasil disimpan! (Skor: ${score}/${totalQuestions})`;
            } catch (error) {
                console.error("Gagal menyimpan skor ke Firestore:", error);
                firestoreStatusEl.textContent = 'Status Penyimpanan Skor: Gagal menyimpan. (Lihat Konsol)';
            }
        }

        // Mulai setup Firebase saat dokumen dimuat
        setupFirebase();

    </script>
    
    <!-- JavaScript Logika Aplikasi -->
    <script>
        // Data Kuis Praktik SQL
        const quizData = [
            {
                question: "Ambil **semua kolom** dari tabel bernama 'Produk'.",
                context: "Tabel: Produk",
                answer: "SELECT * FROM Produk"
            },
            {
                question: "Ambil kolom 'Nama' dan 'Email' dari tabel 'Karyawan' yang memiliki 'Departemen' **'IT'**.",
                context: "Tabel: Karyawan (Kolom: Nama, Email, Departemen)",
                answer: "SELECT Nama, Email FROM Karyawan WHERE Departemen = 'IT'"
            },
            {
                question: "Masukkan data baru ke tabel 'Pelanggan' dengan kolom 'ID' bernilai **5** dan kolom 'Nama' bernilai **'Rina'**.",
                context: "Tabel: Pelanggan (Kolom: ID, Nama)",
                answer: "INSERT INTO Pelanggan (ID, Nama) VALUES (5, 'Rina')"
            },
            {
                question: "Perbarui kolom 'Harga' di tabel 'Barang' menjadi **50000** untuk baris di mana 'ID_Barang' adalah **12**.",
                context: "Tabel: Barang (Kolom: ID_Barang, Harga)",
                answer: "UPDATE Barang SET Harga = 50000 WHERE ID_Barang = 12"
            },
            {
                question: "Hapus baris data dari tabel 'Log' di mana 'Tanggal' adalah **'2025-01-01'**.",
                context: "Tabel: Log (Kolom: Tanggal)",
                answer: "DELETE FROM Log WHERE Tanggal = '2025-01-01'"
            }
        ];

        const quizContainer = document.getElementById('quiz-container');
        const submitBtn = document.getElementById('submit-quiz-btn');
        const resultsEl = document.getElementById('quiz-results');

        // Helper function untuk menormalisasi string SQL (menghilangkan spasi berlebihan dan mengabaikan kapitalisasi)
        function normalizeSQL(sql) {
            // Hapus semua spasi berlebih, ganti newline/tab dengan spasi, trim, dan konversi ke uppercase.
            return sql.replace(/\s+/g, ' ').trim().toUpperCase();
        }

        // Fungsi untuk mengganti tampilan (tab)
        function switchView(viewId) {
            // Sembunyikan semua konten dan hapus kelas aktif dari tombol
            document.querySelectorAll('.view-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('tab-active'));

            // Tampilkan konten yang diminta
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            document.getElementById(`tab-${viewId}`).classList.add('tab-active');

            // Logika khusus untuk Kuis
            if (viewId === 'kuis') {
                renderQuiz();
                resultsEl.classList.add('hidden');
                submitBtn.classList.remove('hidden');
            } else {
                submitBtn.classList.add('hidden');
            }
        }

        // Fungsi untuk merender semua soal kuis praktik
        function renderQuiz() {
            quizContainer.innerHTML = '';
            quizContainer.classList.remove('submitted');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Kirim Jawaban & Periksa';

            quizData.forEach((q, qIndex) => {
                const qCard = document.createElement('div');
                qCard.className = 'question-card mb-6 p-4 rounded-xl bg-white border border-gray-200 shadow-lg';
                qCard.innerHTML = `
                    <p class="text-base font-bold mb-1 text-gray-800">Soal ${qIndex + 1}:</p>
                    <p class="mb-3 text-gray-700">${q.question}</p>
                    <p class="text-xs text-gray-500 mb-2">(${q.context})</p>
                    <textarea 
                        id="sql-input-${qIndex}" 
                        placeholder="Tulis perintah SQL di sini..." 
                        rows="3"
                        class="code-input w-full p-3 border-2 border-gray-300 rounded-lg focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 bg-gray-50 text-gray-800"
                    ></textarea>
                    <div id="feedback-${qIndex}" class="mt-2 text-sm font-semibold hidden"></div>
                `;
                quizContainer.appendChild(qCard);
            });
            submitBtn.classList.remove('hidden');
        }

        // Fungsi untuk mengirimkan dan menilai kuis
        async function submitQuiz() {
            const totalQuestions = quizData.length;
            let score = 0;

            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50');
            document.getElementById('loading-spinner').classList.remove('hidden');
            
            // Beri jeda sebentar untuk visual loading
            await new Promise(resolve => setTimeout(resolve, 500)); 

            // Proses Penilaian
            quizData.forEach((q, qIndex) => {
                const inputEl = document.getElementById(`sql-input-${qIndex}`);
                const feedbackEl = document.getElementById(`feedback-${qIndex}`);
                const userAnswer = inputEl.value;
                const correctAnswer = q.answer;

                inputEl.disabled = true; // Nonaktifkan input setelah submit
                feedbackEl.classList.remove('hidden', 'correct-answer', 'incorrect-answer');
                
                const normalizedUserAnswer = normalizeSQL(userAnswer);
                const normalizedCorrectAnswer = normalizeSQL(correctAnswer);

                if (normalizedUserAnswer === normalizedCorrectAnswer) {
                    score++;
                    feedbackEl.classList.add('correct-answer');
                    feedbackEl.innerHTML = '✅ **BENAR!**';
                    inputEl.classList.add('border-green-500');
                } else {
                    feedbackEl.classList.add('incorrect-answer');
                    feedbackEl.innerHTML = `❌ **SALAH.** Jawaban Benar: <code class="font-normal text-gray-800 bg-gray-100 p-1 rounded">${correctAnswer}</code>`;
                    inputEl.classList.add('border-red-500');
                }
            });

            document.getElementById('loading-spinner').classList.add('hidden');
            submitBtn.classList.remove('opacity-50');
            submitBtn.classList.add('hidden');
            resultsEl.classList.remove('hidden');

            // Tampilkan Hasil
            document.getElementById('final-score').textContent = `${score} / ${totalQuestions}`;
            
            let message = '';
            if (score === totalQuestions) {
                message = "Fantastis! Anda telah menguasai sintaks SQL dasar dengan sempurna.";
            } else if (score >= totalQuestions * 0.6) {
                message = "Kerja bagus! Beberapa kesalahan kecil, tetapi pemahaman Anda sudah kuat.";
            } else {
                message = "Perlu sedikit lebih banyak latihan. Tinjau kembali tab 'Dasar-Dasar SQL' dan coba lagi.";
            }
            document.getElementById('score-message').textContent = message;

            // Simpan Skor ke Firestore
            if (window.saveScoreToFirestore) {
                window.saveScoreToFirestore(score, totalQuestions);
            } else {
                document.getElementById('firestore-status').textContent = 'Status Penyimpanan Skor: Gagal (Firebase tidak terinisialisasi).';
            }
        }

        // Fungsi untuk mengulang kuis
        function resetQuiz() {
            resultsEl.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            renderQuiz();
        }

        // Inisialisasi: Tampilkan konten materi saat pertama kali dimuat
        window.onload = function() {
            switchView('materi');
            renderQuiz(); // Render kuis agar siap saat tab diakses
        };

    </script>

</body>
</html>
